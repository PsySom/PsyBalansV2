# PsyBalans - платформа психологического баланса

PsyBalans - система для осознанного планирования, саморегуляции и восстановления психологического благополучия, помогающая пользователям отслеживать свое эмоциональное состояние, определять потребности и находить баланс в жизни.

## Новые функции персонализации

В проект добавлена расширенная система персонализации на основе пройденных тестов, включающая:

### Персональный дашборд
- **Сводка всех результатов тестов**: визуализация и анализ результатов всех пройденных тестов в одном месте
- **Профиль благополучия**: интерактивная диаграмма с основными показателями психологического благополучия
- **Top-3 области для работы**: автоматическое определение приоритетных областей для улучшения
- **Рекомендуемые упражнения**: персонализированный плейлист упражнений, соответствующих потребностям пользователя

### Умный движок рекомендаций
- **Комплексный анализ**: перекрестный анализ результатов всех тестов для формирования целостной картины
- **Приоритизация срочных потребностей**: при высоком риске выгорания система рекомендует упражнения на снижение стресса
- **Контекстные рекомендации**: учет времени суток (упражнения для улучшения сна рекомендуются вечером)
- **Адаптивная сложность**: прогрессивное увеличение сложности от начинающего до продвинутого уровня
- **Карточки рекомендаций**: каждая рекомендация включает объяснение причин выбора, ожидаемое время, уровень сложности и статистику успешности среди пользователей с похожим профилем

### Прогрессивный онбординг
- **Поэтапное знакомство**: система постепенно раскрывает функции, начиная с базовых тестов
- **Пять ключевых этапов**:
  1. Определение хронотипа (энергетического ритма)
  2. Оценка баланса психологических потребностей
  3. Измерение уровня стресса и риска выгорания
  4. Анализ отношения к себе (самосострадание)
  5. Генерация персонального плана развития

### Система отслеживания прогресса
- **Сохранение данных**: локальное сохранение результатов тестов и выполненных упражнений
- **Отслеживание серий**: подсчет последовательных дней практики для формирования привычки
- **Обучение предпочтениям**: адаптация рекомендаций на основе пользовательского взаимодействия
- **Узнавание возвращающихся пользователей**: система приветствует пользователей и возобновляет их прогресс

### Воронки конверсии
- **Множественные точки входа**: различные пути для регистрации полного аккаунта
- **Сохранение прогресса**: предложение создать аккаунт после выполнения нескольких упражнений
- **Расширенная аналитика**: доступ к детальному анализу результатов тестов при регистрации
- **Социальные функции**: возможность присоединиться к сообществу пользователей
- **Премиум-функции**: персональный AI-коуч для зарегистрированных пользователей

### Приватность и безопасность
- **Прозрачность данных**: четкое объяснение, какие данные собираются и как используются
- **Улучшение рекомендаций**: пояснение, как данные помогают улучшать персональные рекомендации
- **Опции хранения**: выбор между локальным и серверным хранением данных
- **Удаление данных**: возможность полностью удалить свои данные из системы

## Установка и запуск

### Подготовка окружения

1. Клонируйте репозиторий
   ```bash
   git clone https://github.com/yourusername/PsyBalansV2.git
   cd PsyBalansV2
   ```

2. Настройка бэкенда:
   ```bash
   # Windows
   python -m venv venv
   .\venv\Scripts\activate
   pip install -r requirements.txt
   
   # Linux/MacOS
   python3 -m venv venv
   source venv/bin/activate
   pip install -r requirements.txt
   ```

3. Настройка фронтенда:
   ```bash
   cd frontend
   npm install
   ```

### Настройка переменных окружения

1. Создайте файл `.env` в корневой директории проекта (или отредактируйте существующий):
   ```
   # Настройки приложения
   APP_NAME=PsyBalans API
   APP_VERSION=0.1.0
   APP_DESCRIPTION="API для психологической платформы PsyBalans"
   DEBUG=true

   # PostgreSQL настройки
   # Для использования SQLite закомментируйте или удалите эту строку
   # DATABASE_URL=postgresql+asyncpg://username:password@hostname:5432/dbname
   
   # MongoDB настройки
   MONGODB_URL=mongodb://localhost:27017
   MONGODB_DB_NAME=psybalans
   # Для подключения к MongoDB Atlas
   # MONGODB_URL=mongodb+srv://username:password@cluster.mongodb.net/?retryWrites=true&w=majority
   
   # Redis настройки (оставить пустым для in-memory режима)
   REDIS_HOST=localhost
   REDIS_PORT=6379
   REDIS_DB=0
   REDIS_PASSWORD=
   
   # Настройки безопасности
   SECRET_KEY=your-secret-key-here
   ALGORITHM=HS256
   ACCESS_TOKEN_EXPIRE_MINUTES=30
   REFRESH_TOKEN_EXPIRE_DAYS=7
   
   # Настройки логирования
   LOG_LEVEL=INFO  # DEBUG, INFO, WARNING, ERROR
   LOG_FORMAT=json  # json или text
   # LOG_FILE=logs/app.log  # раскомментируйте для записи логов в файл
   ```

### Запуск приложения

#### Запуск бэкенда

1. Используя скрипт (Windows):
   ```
   run.bat
   ```

2. Используя скрипт (Linux/MacOS):
   ```
   ./run.sh
   ```

3. Запуск вручную:
   ```bash
   # Активируйте виртуальное окружение, если еще не активировано
   # Windows
   .\venv\Scripts\activate
   # Linux/MacOS
   source venv/bin/activate

   # Запуск сервера разработки
   uvicorn app.main:app --reload
   ```

4. Откройте API документацию по адресу http://127.0.0.1:8000/docs

#### Запуск фронтенда

1. Запуск в режиме разработки:
   ```bash
   cd frontend
   npm run dev
   ```

2. Сборка для продакшн:
   ```bash
   cd frontend
   npm run build
   ```

3. Предпросмотр продакшн-версии:
   ```bash
   cd frontend
   npm run preview
   ```

4. Запуск Storybook (компоненты UI):
   ```bash
   cd frontend
   npm run storybook
   ```

#### Тестирование новых функций персонализации

1. Запустите фронтенд в режиме разработки:
   ```bash
   cd frontend
   npm run dev
   ```

2. Перейдите по URL: `http://localhost:5173/`

3. Последовательность тестирования основных компонентов:

   - **Интерактивная библиотека упражнений**:
     - Перейдите на страницу "Упражнения"
     - Используйте поиск и фильтры для нахождения упражнений
     - Откройте карточку упражнения для просмотра детальной информации
     - Попробуйте запустить интерактивное упражнение

   - **Персональный дашборд**:
     - Перейдите на страницу "Дашборд"
     - Просмотрите сводку результатов тестов и рекомендации
     - Исследуйте профиль благополучия с основными показателями
     - Ознакомьтесь с приоритетными областями для работы

   - **Прогрессивный онбординг**:
     - Перейдите на страницу "Онбординг"
     - Пройдите первый шаг с определением хронотипа
     - Продолжите онбординг, проходя остальные тесты
     - Получите персональный план на последнем шаге

   - **Планировщик идеального дня**:
     - Перейдите на страницу "Практики" и выберите "Планировщик идеального дня"
     - Выберите хронотип и настройте планировщик
     - Добавьте активности методом перетаскивания
     - Изучите энергетическую кривую дня и рекомендации

   - **Интерактивная практика работы с тревожной мыслью**:
     - Перейдите на страницу "Практики" и выберите "Работа с тревожной мыслью"
     - Пройдите 5-шаговый процесс от записи мысли до составления плана действий
     - Испытайте визуализацию изменения интенсивности эмоций

#### Перезапуск приложения

1. Перезапуск бэкенда:
   - Прервите текущий процесс (Ctrl+C)
   - Выполните команду запуска снова:
     ```bash
     uvicorn app.main:app --reload
     ```

2. Перезапуск фронтенда:
   - Прервите текущий процесс (Ctrl+C)
   - Выполните команду запуска снова:
     ```bash
     cd frontend
     npm run dev
     ```

## Работа с Git и контроль версий

### Основные команды Git

1. Проверка статуса репозитория:
   ```bash
   git status
   ```

2. Получение последних изменений:
   ```bash
   git pull
   ```

3. Создание новой ветки для работы над функционалом:
   ```bash
   git checkout -b feature/название-фичи
   ```

4. Добавление изменений и создание коммита:
   ```bash
   git add .
   git commit -m "Краткое описание изменений"
   ```

5. Отправка изменений на GitHub:
   ```bash
   git push origin feature/название-фичи
   ```

### Рекомендации по именованию веток и коммитов

1. Именование веток:
   - `feature/` - для новых функций (например, `feature/auth-system`)
   - `bugfix/` - для исправления ошибок (например, `bugfix/login-validation`)
   - `refactor/` - для рефакторинга (например, `refactor/api-structure`)
   - `docs/` - для обновления документации (например, `docs/readme-update`)

2. Стиль коммитов:
   - Используйте короткие информативные сообщения в настоящем времени
   - Начинайте с глагола: "Добавляет", "Исправляет", "Обновляет", "Удаляет"
   - Пример: "Добавляет авторизацию пользователей через JWT"

## Текущая структура проекта

### Структура бэкенда (FastAPI)

Бэкенд PsyBalans использует современную архитектуру FastAPI с асинхронными операциями и многослойной структурой.

```
app/
  ├── core/ - ядро приложения
  │   ├── auth.py - аутентификация и авторизация
  │   ├── security.py - безопасность и JWT
  │   ├── database/ - модуль работы с базами данных
  │   │   ├── postgresql.py - взаимодействие с PostgreSQL
  │   │   ├── mongodb.py - взаимодействие с MongoDB
  │   │   ├── redis_client.py - взаимодействие с Redis
  │   │   ├── retry.py - механизм повторных попыток
  │   │   ├── mongodb_indexes.py - настройка индексов MongoDB
  │   │   └── startup.py - инициализация баз данных
  │   ├── logging/ - модуль логирования с контекстом
  │   ├── middleware/ - HTTP и DB middleware
  │   └── resilience/ - отказоустойчивость и circuit breaker
  ├── main.py - основной файл приложения
  ├── models/ - основные модели данных (PostgreSQL)
  │   ├── user.py - модель пользователя
  │   ├── activity.py - модель активностей
  │   ├── activity_types.py - типы и подтипы активностей
  │   ├── needs.py - модель потребностей
  │   ├── user_needs.py - связь пользователя с потребностями
  │   ├── calendar.py - модель календаря и расписания
  │   ├── exercises.py - модель упражнений
  │   └── base.py - базовые классы моделей
  ├── mongodb/ - репозитории и схемы для MongoDB
  │   ├── activity_state_repository.py - репозиторий состояний активностей
  │   ├── activity_state_schemas.py - схемы состояний
  │   ├── diary_repository.py - репозиторий дневников
  │   ├── mood_thought_repository.py - репозиторий мыслей и настроений
  │   ├── recommendations_diary_repository.py - репозиторий рекомендаций
  │   ├── onboarding_repository.py - репозиторий онбординга
  │   └── base_repository.py - базовый класс репозитория
  ├── repositories/ - репозитории для PostgreSQL
  │   ├── user_repository.py - репозиторий пользователей
  │   ├── activity_repository.py - репозиторий активностей
  │   ├── activity_type_repository.py - репозиторий типов активностей
  │   ├── activity_subtype_repository.py - репозиторий подтипов
  │   ├── activity_need_link_repository.py - связи активностей с потребностями
  │   ├── need_repository.py - репозиторий потребностей
  │   ├── user_need_repository.py - репозиторий потребностей пользователя
  │   ├── calendar_repository.py - репозиторий календаря
  │   ├── scale_repository.py - репозиторий шкал наблюдения
  │   └── base_repository.py - базовый класс репозитория
  ├── services/ - сервисный слой
  │   ├── activity_service.py - сервис управления активностями
  │   ├── need_service.py - сервис управления потребностями
  │   ├── recommendation_service.py - сервис рекомендаций
  │   └── state_service.py - сервис отслеживания состояния
  └── modules/ - модули API
      ├── auth/ - модуль аутентификации
      │   └── routes.py - API маршруты аутентификации
      ├── user/ - модуль пользователя
      │   ├── routes.py - API маршруты пользователя
      │   ├── schemas.py - схемы Pydantic
      │   └── service.py - бизнес-логика пользователя
      ├── diary/ - модуль дневников
      │   ├── routes.py - API маршруты дневников
      │   └── schemas.py - схемы дневников
      ├── activity/ - модуль активностей
      │   └── schemas.py - схемы активностей
      ├── activity_state/ - модуль состояний и активностей
      │   └── routes.py - API маршруты состояний
      ├── need/ - модуль потребностей
      │   └── schemas.py - схемы потребностей
      ├── calendar/ - модуль календаря
      │   └── schemas.py - схемы календаря
      └── recommendations_diary/ - модуль рекомендаций
          └── routes.py - API маршруты рекомендаций
```

#### Ключевые особенности бэкенда:

- **Многослойная архитектура**: четкое разделение на слои моделей, репозиториев, сервисов и API
- **Полиглотная персистентность**: использование PostgreSQL, MongoDB и Redis для разных типов данных
- **Асинхронность**: полностью асинхронный код с использованием asyncio
- **Отказоустойчивость**: механизмы повторных попыток, circuit breaker для защиты от каскадных сбоев
- **Типизация**: строгая типизация с использованием Pydantic 2.0+
- **Контекстное логирование**: продвинутое логирование с сохранением контекста запроса
- **Масштабируемость**: модульная структура, облегчающая горизонтальное масштабирование

#### Новые возможности бэкенда:

- **Система шкал наблюдения**: новый модуль для отслеживания различных показателей пользователя
- **Продвинутые индексы производительности**: оптимизация для быстрого доступа к часто запрашиваемым данным
- **Репозиторий онбординга**: хранение и управление прогрессом пользователя в онбординге

### Структура фронтенда (React + TypeScript)

Фронтенд построен на React с TypeScript и использует современные практики организации кода.

```
frontend/
  ├── public/ - статические файлы
  ├── src/ - исходный код
  │   ├── assets/ - изображения, иконки, статические ресурсы
  │   ├── components/ - компоненты UI
  │   │   ├── ui/ - базовые UI компоненты
  │   │   │   ├── Button.tsx - кнопка с различными вариантами
  │   │   │   ├── Card.tsx - карточка для контента
  │   │   │   ├── Text.tsx - текстовый компонент
  │   │   │   ├── Heading.tsx - заголовки
  │   │   │   ├── Section.tsx - секция страницы
  │   │   │   ├── MoodButton.tsx - кнопка выбора настроения
  │   │   │   ├── NavTab.tsx - вкладка навигации
  │   │   │   └── ChatMessage.tsx - сообщение в чате
  │   │   ├── auth/ - компоненты аутентификации
  │   │   │   ├── AuthModal.tsx - модальное окно аутентификации
  │   │   │   ├── LoginForm.tsx - форма входа
  │   │   │   └── RegisterForm.tsx - форма регистрации
  │   │   ├── exercises/ - компоненты упражнений
  │   │   │   ├── ExerciseCard.tsx - карточка упражнения
  │   │   │   ├── ExerciseLibrary.tsx - библиотека упражнений
  │   │   │   ├── QuickReliefSection.tsx - секция быстрого облегчения
  │   │   │   ├── exerciseData.ts - данные упражнений
  │   │   │   └── modals/ - модальные окна с упражнениями
  │   │   │       ├── BreathingExerciseModal.tsx - дыхательные практики
  │   │   │       ├── BodyScanModal.tsx - сканирование тела
  │   │   │       ├── GratitudePracticeModal.tsx - практика благодарности
  │   │   │       ├── PanicReliefModal.tsx - упражнение от панических атак
  │   │   │       ├── SadnessReliefModal.tsx - упражнение от грусти
  │   │   │       ├── SleepReliefModal.tsx - упражнение для сна
  │   │   │       └── OverthinkingReliefModal.tsx - упражнение от руминаций
  │   │   ├── interactive-tests/ - интерактивные тесты
  │   │   │   ├── ChronotypeTest.tsx - тест на хронотип
  │   │   │   ├── BurnoutRiskTest.tsx - тест на риск выгорания
  │   │   │   ├── NeedsBalanceTest.tsx - тест баланса потребностей
  │   │   │   ├── StressResilienceTest.tsx - тест на стрессоустойчивость
  │   │   │   ├── SelfCompassionTest.tsx - тест на самосострадание
  │   │   │   ├── CognitiveBiasTest.tsx - тест на когнитивные искажения
  │   │   │   ├── TestCard.tsx - карточка теста
  │   │   │   ├── TestIntroGuide.tsx - вводная информация о тесте
  │   │   │   ├── TestProgressTracking.tsx - отслеживание прогресса в тесте
  │   │   │   └── TestResultSharing.tsx - компонент для шеринга результатов
  │   │   ├── notifications/ - компоненты уведомлений
  │   │   │   ├── NotificationBadge.tsx - индикатор уведомлений
  │   │   │   ├── NotificationForm.tsx - форма настройки уведомлений
  │   │   │   ├── NotificationPreferences.tsx - предпочтения уведомлений
  │   │   │   └── SubscriptionOptions.tsx - опции подписки
  │   │   ├── dashboard/ - компоненты дашборда
  │   │   │   └── PersonalDashboard.tsx - персональный дашборд
  │   │   ├── practices/ - компоненты практик
  │   │   │   ├── PerfectDayPlanner.tsx - планировщик идеального дня
  │   │   │   └── AnxiousThoughtWorkshop.tsx - работа с тревожной мыслью
  │   │   ├── onboarding/ - компоненты онбординга
  │   │   │   └── ProgressiveOnboarding.tsx - прогрессивный онбординг
  │   │   ├── conversion/ - компоненты воронок конверсии
  │   │   │   └── ConversionPrompts.tsx - побуждающие к конверсии подсказки
  │   │   ├── science/ - компоненты научной базы
  │   │   │   ├── MethodCard.tsx - карточка метода
  │   │   │   ├── TherapyApproachesMap.tsx - карта подходов психотерапии
  │   │   │   ├── DigitalTherapyStats.tsx - статистика цифровой терапии
  │   │   │   └── NeuroscienceSlider.tsx - слайдер нейробиологических основ
  │   │   ├── welcome/ - компоненты приветственных страниц
  │   │   │   ├── HeroSection.tsx - основная секция приветствия
  │   │   │   ├── FeaturesShowcase.tsx - демонстрация возможностей
  │   │   │   ├── HowItWorksSection.tsx - как это работает
  │   │   │   ├── TestimonialsSection.tsx - отзывы пользователей
  │   │   │   ├── ScienceFoundation.tsx - научная база
  │   │   │   ├── CTASection.tsx - призыв к действию
  │   │   │   ├── PainPointsSection.tsx - болевые точки пользователя
  │   │   │   ├── AudienceSection.tsx - целевая аудитория
  │   │   │   ├── UniqueApproachSection.tsx - уникальный подход
  │   │   │   ├── HeaderSection.tsx - секция заголовка
  │   │   │   ├── FooterSection.tsx - секция футера
  │   │   │   ├── Roadmap.tsx - дорожная карта проекта
  │   │   │   ├── GlassBox.tsx - компонент с эффектом стекла
  │   │   │   ├── GlassCard.tsx - карточка с эффектом стекла
  │   │   │   ├── GradientText.tsx - текст с градиентом
  │   │   │   ├── ScrollToTopButton.tsx - кнопка скролла наверх
  │   │   │   ├── ParticleBackground.tsx - фон с частицами
  │   │   │   └── animations.css - анимации для welcome страницы
  │   ├── hooks/ - пользовательские React-хуки
  │   │   ├── useLocalStorage.ts - хук для работы с localStorage
  │   │   └── index.ts - экспорты всех хуков
  │   ├── pages/ - компоненты страниц
  │   │   ├── Home.tsx - главная страница
  │   │   ├── About.tsx - страница о проекте
  │   │   ├── Dashboard.tsx - личный кабинет
  │   │   ├── Diaries.tsx - дневники
  │   │   ├── Calendar.tsx - календарь активностей
  │   │   ├── State.tsx - состояние пользователя
  │   │   ├── Recommendations.tsx - рекомендации
  │   │   ├── Profile.tsx - профиль пользователя
  │   │   ├── NotFound.tsx - страница 404
  │   │   ├── Onboarding.tsx - страница онбординга
  │   │   ├── Practices.tsx - страница практик
  │   │   ├── ScienceBase.tsx - научная база
  │   │   ├── WelcomeV3.tsx - приветственная страница v3
  │   │   ├── WelcomeV4.tsx - приветственная страница v4
  │   │   ├── StyleGuide.tsx - гайд по стилям
  │   │   ├── NotificationCenter.tsx - центр уведомлений
  │   │   └── PersonalizedExperience.tsx - персонализированный опыт
  │   ├── store/ - управление состоянием (Zustand)
  │   │   ├── useAppStore.ts - основной стор приложения
  │   │   ├── useAppStore.test.ts - тесты для стора
  │   │   └── index.ts - экспорты сторов
  │   ├── services/ - сервисы для работы с API
  │   │   ├── notificationService.ts - сервис уведомлений
  │   │   ├── recommendationEngine.ts - движок рекомендаций
  │   │   └── userProgressService.ts - сервис прогресса пользователя
  │   ├── theme/ - настройка темы и стилей
  │   │   ├── theme.ts - тема Chakra UI
  │   │   ├── typography.ts - настройки типографики
  │   │   ├── spacing.ts - настройки отступов
  │   │   ├── animations.css - глобальные анимации
  │   │   └── scrollbars.css - стили скроллбаров
  │   ├── utils/ - вспомогательные функции
  │   │   ├── api.ts - обработка API запросов
  │   │   └── index.ts - экспорты утилит
  │   ├── router-config.ts - конфигурация маршрутизации
  │   ├── App.tsx - корневой компонент приложения
  │   └── main.tsx - точка входа
  ├── eslint.config.js - конфигурация ESLint
  ├── vite.config.ts - конфигурация Vite
  └── tsconfig.json - настройки TypeScript
```

#### Ключевые особенности фронтенда:

- **Компонентная архитектура**: модульная структура с четким разделением ответственности
- **Строгая типизация**: использование TypeScript с строгим режимом для предотвращения ошибок
- **Стилизация через Chakra UI**: единая система дизайна с поддержкой темной/светлой темы
- **Управление состоянием через Zustand**: легковесное и эффективное управление глобальным состоянием
- **Маршрутизация React Router**: конфигурация с поддержкой future flags для совместимости с React Router v7
- **Оптимизированная сборка**: использование Vite для быстрой разработки и оптимальной сборки

#### Новые возможности фронтенда:

- **Эффекты стекла (glassmorphism)**: современные UI компоненты с эффектом матового стекла
- **Улучшенные анимации**: плавные анимации и переходы с использованием keyframes из @emotion/react
- **Прогрессивный онбординг**: пошаговое знакомство с функциями приложения
- **Интерактивные практики**: специализированные компоненты для работы с тревожными мыслями и планирования дня
- **Расширенный дашборд**: визуализация результатов тестов и персональных рекомендаций

## Полиглотная система баз данных

PsyBalans использует три базы данных для различных типов данных:

### PostgreSQL (для структурированных данных)

Основные таблицы:
- **users**: Пользователи системы
- **activity_types**: Типы активностей
- **activity_subtypes**: Подтипы активностей
- **activities**: Конкретные активности
- **needs**: Психологические потребности
- **need_categories**: Категории потребностей
- **user_needs**: Связь пользователей и потребностей
- **activity_need_link**: Связь активностей и потребностей
- **activity_schedules**: Запланированные активности
- **scales**: Шкалы наблюдения (-5 до +5)
- **scale_categories**: Категории шкал наблюдения

### MongoDB (для полуструктурированных данных)

Основные коллекции:
- **mood_entries**: Записи о настроении
- **thought_entries**: Записи о мыслях
- **activity_states**: Состояния активностей
- **diary_entries**: Дневниковые записи
- **recommendations**: Рекомендации системы
- **onboarding_progress**: Прогресс онбординга

### Redis (для кэширования и временных данных)

Основные применения:
- Кэширование частых запросов
- Хранение сессий
- Обмен сообщениями
- Временные данные аналитики

## Будущие улучшения (Roadmap)

### Бэкенд
- Добавление WebSocket для обновлений в реальном времени
- Реализация Celery для асинхронных задач
- Интеграция с внешними API (календари, трекеры здоровья)
- Система уведомлений с настраиваемыми триггерами
- Интеграция с AI-моделями для анализа текста дневников

### Фронтенд
- Поддержка оффлайн-режима (PWA)
- Расширенные настройки профиля
- Интеграция с внешними сервисами
- Оптимизация производительности и lazy loading
- Предпроцессинг и оптимизация сборки для продакшн

## Авторы и контрибьюторы

- **Основной разработчик**: [ВашеИмя](https://github.com/yourusername)
- **Контрибьюторы**: список контрибьюторов

## Лицензия

[MIT](LICENSE)